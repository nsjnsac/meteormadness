<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<link rel="shorcut icon" href="icon.jpeg" type="image/x-icon">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NSJ - Visor de Órbitas NEO 3D</title>

<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.157.0/examples/jsm/"
  }
}
</script>

<style>
  :root {
    --bg-dark: #02030a;
    --panel-bg: rgba(8, 12, 24, 0.88);
    --text-primary: #e6f0ff;
    --text-muted: #9fb0d8;
    --accent: #ffd07a;
    --accent-hazardous: #ff8a8a;
    --accent-safe: #8aff9e;
    --border-color: rgba(255, 255, 255, 0.05);
  }
  html, body { height: 100%; margin: 0; background: var(--bg-dark); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; color: var(--text-primary); overflow: hidden; }
  #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
  canvas { display: block; }
  .ui-panel { position: absolute; z-index: 10; background: var(--panel-bg); backdrop-filter: blur(6px); border-radius: 12px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid var(--border-color); transition: all 0.3s ease-out; }
  #controls-panel { top: 15px; left: 15px; width: 380px; }
  #info-panel { top: 15px; right: 15px; width: 380px; max-height: calc(100% - 40px); overflow-y: auto; }
  #info-panel.hidden { display: none; }
  .close-btn { position: absolute; top: 10px; right: 10px; background: none; border: none; color: var(--text-muted); font-size: 20px; cursor: pointer; }
  .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
  h1 { font-size: 20px; margin: 0; }
  h2 { font-size: 16px; margin: 16px 0 8px 0; color: var(--accent); border-bottom: 1px solid var(--border-color); padding-bottom: 6px; }
  .row { display: flex; gap: 8px; align-items: center; margin-bottom: 10px; }
  .row label { min-width: 70px; color: var(--text-muted); font-size: 14px; }
  button, input, select { background: rgba(255,255,255,0.04); border: 1px solid var(--border-color); color: var(--text-primary); padding: 8px 12px; border-radius: 8px; cursor: pointer; font-family: inherit; font-size: 14px; }
  select { flex: 1; }
  button:hover, select:hover { background: rgba(255,255,255,0.08); }
  button.toggled { outline: 2px solid var(--accent); background: rgba(255, 208, 122, 0.1); }
  button:disabled { opacity: 0.4; cursor: not-allowed; }
  input[type="text"], input[type="date"] { flex: 1; }
  #info-content .info-item { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 6px; padding: 4px 0; }
  #info-content .info-item span:first-child { color: var(--text-muted); }
  #info-content .info-item span:last-child { font-weight: 600; text-align: right; }
  .hazardous { color: var(--accent-hazardous) !important; }
  .safe { color: var(--accent-safe) !important; }
  #footer { position: absolute; bottom: 15px; left: 15px; color: var(--text-muted); font-size: 12px; display: flex; gap: 10px; }
  a { color: var(--accent); text-decoration: none; }
  .label { color: #fff; font-family: sans-serif; padding: 2px; background: rgba(0, 0, 0, 0.6); border-radius: 4px; font-size: 12px; }
  #status-message { font-size: 12px; color: var(--text-muted); margin-top: 10px; height: 16px; transition: opacity 0.5s; }
  #impact-alert { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255, 0, 0, 0.8); color: white; padding: 20px; border-radius: 10px; z-index: 100; display: none; text-align: center; font-size: 1.5em; white-space: pre; }
  
  .popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); z-index: 1000; display: none; justify-content: center; align-items: center; }
  .popup-content { position: relative; background: var(--panel-bg); padding: 25px; border-radius: 12px; border: 1px solid var(--border-color); width: 90%; max-width: 700px; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.6); }
  .popup-close-btn { position: absolute; top: 15px; right: 15px; background: none; border: none; color: var(--text-muted); font-size: 24px; cursor: pointer; line-height: 1; padding: 5px; }
  .popup-content h1 { color: var(--accent); margin-top: 0; font-size: 1.5em; }
  .popup-content h2 { font-size: 1.1em; color: var(--text-primary); border-bottom: none; padding-bottom: 0; margin-bottom: 10px; }
  .popup-content p { font-size: 0.9em; line-height: 1.6; color: var(--text-muted); margin-bottom: 10px; }
  .popup-content small { font-size: 0.8em; color: var(--text-muted); opacity: 0.7; }
  .popup-divider { border: none; border-top: 1px solid var(--border-color); margin: 20px 0; }

  #menu-toggle-btn { display: none; font-size: 20px; padding: 4px 10px; }

  @media (max-width: 800px) {
    .ui-panel { width: calc(100% - 30px); }
    #info-panel { top: auto; bottom: 15px; right: 15px; }
    #menu-toggle-btn { display: block; }
    #controls-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out, padding 0.4s ease-out; padding-top: 0; padding-bottom: 0; margin-top: -16px; }
    #controls-panel.expanded #controls-content { max-height: 500px; padding-top: 16px; margin-top: 0; }
  }
</style>
</head>
<body>

  <div id="canvas-container"></div>
  <div id="controls-panel" class="ui-panel">
    <div class="panel-header">
      <h1 data-lang-key="title">Visor de Órbitas NEO</h1>
      <button id="menu-toggle-btn">☰</button>
    </div>
    <div id="controls-content">
      <div class="row">
        <input id="api-key-input" data-lang-key="apiKeyPlaceholder" type="text" placeholder="Pega tu clave de API de la NASA aquí">
        <button id="load-neos-btn" data-lang-key="loadNeos">Cargar NEOs Recientes</button>
      </div>
      <div id="status-message"></div>
      <hr style="border:none; border-top:1px solid var(--border-color); margin: 16px 0;"/>
      <div class="row">
        <label data-lang-key="speed">Velocidad</label>
        <button class="time-btn" data-scale="1">1x</button>
        <button class="time-btn" data-scale="5">5x</button>
        <button class="time-btn" data-scale="10">10x</button>
        <button class="time-btn" data-scale="20">20x</button>
        <button class="time-btn" data-scale="100">100x</button>
      </div>
      <div class="row">
        <label data-lang-key="control">Control</label>
        <button id="resume-btn" title="Reanudar">▶</button>
        <button id="pause-btn" title="Pausar">||</button>
      </div>
      <div class="row">
        <label for="date-picker" data-lang-key="goToDate">Ir a Fecha</label>
        <input type="date" id="date-picker">
        <button id="go-to-date-btn" data-lang-key="go">Ir</button>
      </div>
      <div class="row">
          <label for="neo-selector" data-lang-key="goToNeo">Ir a NEO</label>
          <select id="neo-selector">
              <option value="" data-lang-key="selectNeo">Selecciona un NEO</option>
          </select>
          <button id="go-to-neo-btn" data-lang-key="go">Ir</button>
      </div>
    </div>
  </div>
  <div id="info-panel" class="ui-panel hidden">
    <button class="close-btn" onclick="document.getElementById('info-panel').classList.add('hidden')">&times;</button>
    <h2 id="neo-name"></h2>
    <div id="info-content"></div>
  </div>
  <div id="footer">
    <button id="risk-btn" data-lang-key="humanRisk" style="padding: 4px 8px; font-size: 12px;">Riesgo Humano</button>
    <button id="lang-switch-btn" style="padding: 4px 8px; font-size: 12px;">English Version</button>
  </div>
  <div id="impact-alert"></div>

  <div id="human-risk-popup-overlay" class="popup-overlay">
    <div class="popup-content">
      <button class="popup-close-btn">&times;</button>
      <h1 data-lang-key="popupTitle">Riesgo Humano: Casos Documentados</h1>
      <div class="news-item">
        <h2 data-lang-key="popupHodgesTitle">1. Ann Hodges — Sylacauga, Alabama (Estados Unidos, 1954)</h2>
        <p data-lang-key="popupHodgesP1">El caso más emblemático y científicamente documentado es el de Ann Elizabeth Fowler Hodges, una mujer de 34 años que fue golpeada por un meteorito el 30 de noviembre de 1954 en Sylacauga, Alabama.</p>
        <p data-lang-key="popupHodgesP2">El meteorito —una condrita ordinaria tipo H4 de 3,8 kilogramos— atravesó el techo de su casa, rebotó en un mueble y la impactó en el muslo izquierdo y el costado del abdomen, causándole un hematoma severo.</p>
        <p data-lang-key="popupHodgesP3">Afortunadamente, Ann sobrevivió, convirtiéndose en la única persona confirmada por la NASA y el Smithsonian que ha sido golpeada directamente por un meteorito.</p>
        <p data-lang-key="popupHodgesP4">Este caso fue verificado mediante análisis mineralógicos y espectroscópicos del fragmento, hoy conservado en el National Museum of Natural History (EE.UU.). El evento cambió la forma en que los científicos y el público perciben el peligro de los meteoritos pequeños.</p>
        <small data-lang-key="popupHodgesSrc">(Fuentes: National Geographic, 2013; Encyclopedia of Alabama; Smithsonian National Museum of Natural History.)</small>
      </div>
      <hr class="popup-divider">
      <div class="news-item">
        <h2 data-lang-key="popupMbaleTitle">2. Mbale, Uganda (1992)</h2>
        <p data-lang-key="popupMbaleP1">El 14 de agosto de 1992, una lluvia de pequeños meteoritos cayó sobre la ciudad de Mbale, en Uganda, luego de que una bola de fuego cruzara el cielo. Uno de los fragmentos, del tamaño de una nuez, golpeó suavemente a una mujer en la cabeza mientras caminaba, sin causarle heridas graves.</p>
        <p data-lang-key="popupMbaleP2">Este evento fue estudiado por científicos del Natural History Museum de Londres y registrado en la Meteoritical Bulletin Database. Los análisis demostraron que el material correspondía a una condrita tipo L5, una de las variedades más comunes de meteoritos rocosos.</p>
        <p data-lang-key="popupMbaleP3">El caso Mbale es uno de los pocos en los que se ha confirmado que un meteorito pequeño impactó directamente a un ser humano sin consecuencias fatales, reforzando la idea de que estos objetos pueden representar un peligro real incluso en pequeñas escalas.</p>
        <small data-lang-key="popupMbaleSrc">(Fuentes: Natural History Museum, London; Meteoritical Bulletin Database, 1992; Jenniskens et al., Meteoritics & Planetary Science.)</small>
      </div>
      <hr class="popup-divider">
      <div class="news-item">
        <h2 data-lang-key="popupValeraTitle">3. Valera, Venezuela (1972)</h2>
        <p data-lang-key="popupValeraP1">En 1972, en la región de Valera (Trujillo, Venezuela), un pequeño meteorito de unos 2 kilogramos cayó en una hacienda rural y golpeó mortalmente a una vaca.</p>
        <p data-lang-key="popupValeraP2">El fragmento fue recuperado por los pobladores y posteriormente analizado por expertos del Smithsonian Institution y el Venezuelan Institute for Scientific Research (IVIC), quienes confirmaron que se trataba de una condrita L5, un meteorito de origen asteroidal.</p>
        <p data-lang-key="popupValeraP3">Aunque no afectó directamente a una persona, este evento se usa frecuentemente en investigaciones científicas para ilustrar cómo meteoritos pequeños pueden causar daño físico directo, incluso sin generar cráteres o incendios.</p>
        <small data-lang-key="popupValeraSrc">(Fuentes: Meteoritical Bulletin Database; Smithsonian Institution Archives, 1973.)</small>
      </div>
    </div>
  </div>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { CSS2DRenderer, CSS2DObject } from 'three/addons/renderers/CSS2DRenderer.js';

// =============================================================================
// CONFIGURACIÓN INICIAL
// =============================================================================
const AU_TO_UNITS = 150;
const EARTH_RADIUS_UNITS = 0.02 * AU_TO_UNITS * 4.0;
const GAUSS_K = 0.01720209895;
const BASE_SIMULATION_SPEED_DAYS_PER_SEC = 1;
const IMPACT_DATA_KEY = 'neoImpactData';

// =============================================================================
// INICIALIZACIÓN DE LA ESCENA 3D Y RENDERERS
// =============================================================================
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 50000);
camera.position.set(1.5 * AU_TO_UNITS, 1.5 * AU_TO_UNITS, 2.5 * AU_TO_UNITS);

const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(window.devicePixelRatio);
document.getElementById('canvas-container').appendChild(renderer.domElement);

const labelRenderer = new CSS2DRenderer();
labelRenderer.setSize(window.innerWidth, window.innerHeight);
labelRenderer.domElement.style.position = 'absolute';
labelRenderer.domElement.style.top = '0px';
labelRenderer.domElement.style.pointerEvents = 'none';
document.getElementById('canvas-container').appendChild(labelRenderer.domElement);

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.dampingFactor = 0.05;
controls.target.set(0, 0, 0);
controls.mouseButtons = { LEFT: THREE.MOUSE.PAN, MIDDLE: THREE.MOUSE.DOLLY, RIGHT: THREE.MOUSE.ROTATE };

window.addEventListener('resize', () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
  labelRenderer.setSize(window.innerWidth, window.innerHeight);
});

// =============================================================================
// ELEMENTOS DE LA ESCENA (ESTRELLAS, SOL, TIERRA)
// =============================================================================
function createStarfield() {
    const vertices = [];
    for (let i = 0; i < 10000; i++) {
        const x = THREE.MathUtils.randFloatSpread(40000);
        const y = THREE.MathUtils.randFloatSpread(40000);
        const z = THREE.MathUtils.randFloatSpread(40000);
        vertices.push(x, y, z);
    }
    const geometry = new THREE.BufferGeometry();
    geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
    const material = new THREE.PointsMaterial({ color: 0x888888, size: 2, sizeAttenuation: false });
    const stars = new THREE.Points(geometry, material);
    scene.add(stars);
}

const textureLoader = new THREE.TextureLoader();
const meteorTexture = textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/moon_1024.jpg');

function createLabel(text, langKey) {
  const div = document.createElement('div');
  div.className = 'label';
  div.textContent = text;
  if (langKey) {
    div.dataset.langKey = langKey;
  }
  return new CSS2DObject(div);
}

const sunTexture = textureLoader.load('https://raw.githubusercontent.com/jeromeetienne/threex.planets/master/images/sunmap.jpg');
const sun = new THREE.Mesh(
  new THREE.SphereGeometry(0.1 * AU_TO_UNITS, 64, 64),
  new THREE.MeshBasicMaterial({ map: sunTexture })
);
const sunLabel = createLabel('Sol', 'sun');
sunLabel.position.set(0, 0.1 * AU_TO_UNITS, 0);
sun.add(sunLabel);
scene.add(sun);

const sunLight = new THREE.PointLight(0xffffff, 1.5, 0, 0);
scene.add(sunLight);
scene.add(new THREE.AmbientLight(0xffffff, 0.1));

const earthTexture = textureLoader.load('https://raw.githubusercontent.com/jeromeetienne/threex.planets/master/images/earthmap1k.jpg');
const earth = new THREE.Mesh(
  new THREE.SphereGeometry(EARTH_RADIUS_UNITS, 32, 32),
  new THREE.MeshPhongMaterial({ map: earthTexture })
);
const earthLabel = createLabel('Tierra', 'earth');
earthLabel.position.set(0, EARTH_RADIUS_UNITS * 1.5, 0);
earth.add(earthLabel);
scene.add(earth);

let impactMarker = null;

const orbitsGroup = new THREE.Group();
const neosGroup = new THREE.Group();
scene.add(orbitsGroup, neosGroup);

// =============================================================================
// LÓGICA ORBITAL
// =============================================================================
const deg2rad = (d) => d * Math.PI / 180;

function solveKepler(meanAnomaly, eccentricity, tolerance = 1e-9) {
  let E = meanAnomaly;
  let delta = 1;
  for (let i = 0; i < 100 && Math.abs(delta) > tolerance; i++) {
    delta = (E - eccentricity * Math.sin(E) - meanAnomaly) / (1 - eccentricity * Math.cos(E));
    E -= delta;
  }
  return E;
}

function getPositionFromOrbitalElements(elements, date) {
  const a = parseFloat(elements.semi_major_axis);
  const e = parseFloat(elements.eccentricity);
  const i = deg2rad(parseFloat(elements.inclination));
  const Omega = deg2rad(parseFloat(elements.ascending_node_longitude));
  const omega = deg2rad(parseFloat(elements.perihelion_argument));
  const M0 = deg2rad(parseFloat(elements.mean_anomaly));
  const epoch = new Date(elements.epoch_date_osculation).getTime();

  if ([a, e, i, Omega, omega, M0, epoch].some(isNaN)) {
    return null;
  }

  const timeSinceEpoch = (date.getTime() - epoch) / (1000 * 60 * 60 * 24);
  const meanMotion = GAUSS_K / Math.sqrt(a * a * a);
  const meanAnomaly = M0 + meanMotion * timeSinceEpoch;
  const eccentricAnomaly = solveKepler(meanAnomaly, e);
  const x_orb = a * (Math.cos(eccentricAnomaly) - e);
  const y_orb = a * Math.sqrt(1 - e * e) * Math.sin(eccentricAnomaly);
  const cosO = Math.cos(Omega), sinO = Math.sin(Omega);
  const cosw = Math.cos(omega), sinw = Math.sin(omega);
  const cosi = Math.cos(i), sini = Math.sin(i);
  const x = (cosO * cosw - sinO * sinw * cosi) * x_orb + (-cosO * sinw - sinO * cosw * cosi) * y_orb;
  const y = (sinO * cosw + cosO * sinw * cosi) * x_orb + (-sinO * sinw + cosO * cosw * cosi) * y_orb;
  const z = (sinw * sini) * x_orb + (cosw * sini) * y_orb;
  return new THREE.Vector3(x, z, -y).multiplyScalar(AU_TO_UNITS);
}

// =============================================================================
// MANEJO DE DATOS Y OBJETOS
// =============================================================================
let neos = [];
let selectedNeo = null;
let simState = { date: new Date(), timeScale: 1, isPaused: false };

const earthOrbitalElements = {
  semi_major_axis: "1.00000011",
  eccentricity: "0.01671022",
  inclination: "0.00005",
  ascending_node_longitude: "-11.26064",
  perihelion_argument: "102.94719",
  mean_anomaly: "100.46435",
  epoch_date_osculation: "2000-01-01T12:00:00Z"
};

function createOrbitLine(elements, color = 0xffffff) {
    const points = [];
    const epochDate = new Date(elements.epoch_date_osculation);
    for (let i = 0; i <= 360; i++) {
        const tempElements = { ...elements, mean_anomaly: i };
        const pos = getPositionFromOrbitalElements(tempElements, epochDate);
        if (pos) points.push(pos);
    }
    if (points.length < 2) return null;
    const geometry = new THREE.BufferGeometry().setFromPoints(points);
    const material = new THREE.LineBasicMaterial({ color, transparent: true, opacity: 0.4 });
    return new THREE.Line(geometry, material);
}

const earthOrbitLine = createOrbitLine(earthOrbitalElements, 0x6699ff);
if (earthOrbitLine) orbitsGroup.add(earthOrbitLine);

function clearAllNeos() {
  neos.forEach(neo => {
    if (neo.mesh) neosGroup.remove(neo.mesh);
    if (neo.orbitLine) orbitsGroup.remove(neo.orbitLine);
    if (neo.label) neo.mesh.remove(neo.label);
  });
  neos = [];
  selectedNeo = null;
  document.getElementById('info-panel').classList.add('hidden');
  document.getElementById('neo-selector').innerHTML = '<option value="">Selecciona un NEO</option>';
}

function addNeoToScene(neoData, size) {
  if (!neoData.orbital_data || getPositionFromOrbitalElements(neoData.orbital_data, new Date()) === null) {
    console.warn(`Datos orbitales inválidos o incompletos para el NEO: ${neoData.name}. Se omitirá.`);
    return false;
  }

  const isHazardous = neoData.is_potentially_hazardous_asteroid;
  
  const material = new THREE.MeshPhongMaterial({
    map: meteorTexture,
    emissive: isHazardous ? 0xff0000 : 0xffff00,
    emissiveIntensity: 0
  });
  
  const geometry = new THREE.SphereGeometry(size, 16, 16);
  const mesh = new THREE.Mesh(geometry, material);
  
  const orbitLine = createOrbitLine(neoData.orbital_data);
  if (!orbitLine) return false;

  const label = createLabel(neoData.name);
  label.position.set(0, size * 1.5, 0);
  label.visible = true;
  mesh.add(label);
  
  mesh.userData = { id: neoData.id };
  neosGroup.add(mesh);
  orbitsGroup.add(orbitLine);
  
  const neoObject = { ...neoData, mesh, orbitLine, label, hasImpacted: false, impactDate: null };
  
  if (neoData.predictedImpactDate) {
      const [day, month, year] = neoData.predictedImpactDate.split('/');
      neoObject.potentialImpactDate = new Date(year, month - 1, day);
  }

  neos.push(neoObject);
  return true;
}

// =============================================================================
// DATOS CURADOS Y CONEXIÓN CON LA API
// =============================================================================
const curatedNeosData = [
    { id: "Eros", name: "433 Eros", diameter_km: 16.8, material: "S-type (rocoso)", velocity_kms: 5.5, mass_kg: 6.687e15, close_approach_au: 0.1498, orbiting_body: "Sol", is_potentially_hazardous_asteroid: true, predictedImpactDate: "24/01/2056", orbital_data: { semi_major_axis: "1.458", eccentricity: "0.223", inclination: "10.829", ascending_node_longitude: "304.3", perihelion_argument: "178.6", mean_anomaly: "212.8", epoch_date_osculation: "2023-01-01T00:00:00Z" } },
    { id: "Albert", name: "719 Albert", diameter_km: 2.5, material: "S-like (rocoso)", velocity_kms: 18.38, mass_kg: 2e13, close_approach_au: 0.205, orbiting_body: "Sol", is_potentially_hazardous_asteroid: false, orbital_data: { semi_major_axis: "2.633", eccentricity: "0.548", inclination: "11.57", ascending_node_longitude: "183.85", perihelion_argument: "155.8", mean_anomaly: "16.9", epoch_date_osculation: "2024-11-10T00:00:00Z" } },
    { id: "Alinda", name: "887 Alinda", diameter_km: 4, material: "S-type (rocoso)", velocity_kms: 18.94, mass_kg: 1e14, close_approach_au: 0.095, orbiting_body: "Sol", is_potentially_hazardous_asteroid: false, orbital_data: { semi_major_axis: "2.475", eccentricity: "0.567", inclination: "9.39", ascending_node_longitude: "110.6", perihelion_argument: "350.1", mean_anomaly: "11.3", epoch_date_osculation: "2024-11-10T00:00:00Z" } },
    { id: "Ganymed", name: "1036 Ganymed", diameter_km: 35, material: "S-type (rocoso)", velocity_kms: 14.3, mass_kg: 7e16, close_approach_au: 0.359, orbiting_body: "Sol", is_potentially_hazardous_asteroid: false, orbital_data: { semi_major_axis: "2.663", eccentricity: "0.533", inclination: "26.69", ascending_node_longitude: "215.5", perihelion_argument: "132.4", mean_anomaly: "343.5", epoch_date_osculation: "2024-11-10T00:00:00Z" } },
    { id: "Amor", name: "1221 Amor", diameter_km: 1.5, material: "S-type (silicáceo)", velocity_kms: 14.5, mass_kg: 2e12, close_approach_au: 0.1069, orbiting_body: "Sol", is_potentially_hazardous_asteroid: false, orbital_data: { semi_major_axis: "1.919", eccentricity: "0.435", inclination: "11.88", ascending_node_longitude: "171.3", perihelion_argument: "26.4", mean_anomaly: "357.2", epoch_date_osculation: "2024-11-10T00:00:00Z" } },
    { id: "Icarus", name: "1566 Icarus", diameter_km: 1.2, material: "S-type (rocoso)", velocity_kms: 21.3, mass_kg: 3.9e12, close_approach_au: 0.04248, orbiting_body: "Sol", is_potentially_hazardous_asteroid: true, predictedImpactDate: "11/06/2068", orbital_data: { semi_major_axis: "1.078", eccentricity: "0.827", inclination: "22.84", ascending_node_longitude: "88.0", perihelion_argument: "31.2", mean_anomaly: "176.4", epoch_date_osculation: "2024-11-10T00:00:00Z" } },
    { id: "Betulia", name: "1580 Betulia", diameter_km: 4.2, material: "C-type (oscuro)", velocity_kms: 20.1, mass_kg: 2e14, close_approach_au: 0.0406, orbiting_body: "Sol", is_potentially_hazardous_asteroid: false, orbital_data: { semi_major_axis: "2.196", eccentricity: "0.489", inclination: "52.08", ascending_node_longitude: "62.2", perihelion_argument: "159.4", mean_anomaly: "339.3", epoch_date_osculation: "2024-11-10T00:00:00Z" } },
    { id: "Geographos", name: "1620 Geographos", diameter_km: 2.55, material: "S-type (rocoso)", velocity_kms: 25.2, mass_kg: 2.4e13, close_approach_au: 0.0301, orbiting_body: "Sol", is_potentially_hazardous_asteroid: true, predictedImpactDate: "15/05/2065", orbital_data: { semi_major_axis: "1.245", eccentricity: "0.335", inclination: "13.33", ascending_node_longitude: "337.2", perihelion_argument: "276.8", mean_anomaly: "3.9", epoch_date_osculation: "2024-11-10T00:00:00Z" } },
    { id: "Ivar", name: "1627 Ivar", diameter_km: 7.75, material: "S-type (silicáceo)", velocity_kms: 22.6, mass_kg: 8e14, close_approach_au: 0.110963, orbiting_body: "Sol", is_potentially_hazardous_asteroid: false, orbital_data: { semi_major_axis: "1.863", eccentricity: "0.397", inclination: "8.45", ascending_node_longitude: "132.8", perihelion_argument: "169.6", mean_anomaly: "350.1", epoch_date_osculation: "2024-11-10T00:00:00Z" } },
    { id: "Toro", name: "1685 Toro", diameter_km: 3.5, material: "S-type (silicáceo)", velocity_kms: 24.4, mass_kg: 5.6e13, close_approach_au: 0.0520, orbiting_body: "Sol", is_potentially_hazardous_asteroid: true, predictedImpactDate: "08/08/2045", orbital_data: { semi_major_axis: "1.367", eccentricity: "0.436", inclination: "9.38", ascending_node_longitude: "274.4", perihelion_argument: "127.1", mean_anomaly: "31.2", epoch_date_osculation: "2024-11-10T00:00:00Z" } },
    { id: "Apollo", name: "1862 Apollo", diameter_km: 1.5, material: "Q-type", velocity_kms: 20.0, mass_kg: 4e12, close_approach_au: 0.025, orbiting_body: "Sol", is_potentially_hazardous_asteroid: true, predictedImpactDate: "10/11/2070", orbital_data: { semi_major_axis: "1.470", eccentricity: "0.560", inclination: "6.35", ascending_node_longitude: "35.8", perihelion_argument: "285.7", mean_anomaly: "356.9", epoch_date_osculation: "2024-11-10T00:00:00Z" } },
    { id: "Antinous", name: "1863 Antinous", diameter_km: 2.1, material: "S-type", velocity_kms: 19.0, mass_kg: 1.2e13, close_approach_au: 0.2, orbiting_body: "Sol", is_potentially_hazardous_asteroid: false, orbital_data: { semi_major_axis: "2.259", eccentricity: "0.606", inclination: "18.39", ascending_node_longitude: "346.4", perihelion_argument: "247.1", mean_anomaly: "349.8", epoch_date_osculation: "2024-11-10T00:00:00Z" } },
    { id: "Daedalus", name: "1864 Daedalus", diameter_km: 3.0, material: "S-type", velocity_kms: 25.0, mass_kg: 3e13, close_approach_au: 0.03, orbiting_body: "Sol", is_potentially_hazardous_asteroid: true, predictedImpactDate: "20/06/2059", orbital_data: { semi_major_axis: "1.461", eccentricity: "0.614", inclination: "22.19", ascending_node_longitude: "11.0", perihelion_argument: "325.5", mean_anomaly: "349.6", epoch_date_osculation: "2024-11-10T00:00:00Z" } },
    { id: "Cerberus", name: "1865 Cerberus", diameter_km: 1.2, material: "S-type", velocity_kms: 22.0, mass_kg: 2.5e12, close_approach_au: 0.1, orbiting_body: "Sol", is_potentially_hazardous_asteroid: true, orbital_data: { semi_major_axis: "1.080", eccentricity: "0.467", inclination: "16.09", ascending_node_longitude: "195.1", perihelion_argument: "325.1", mean_anomaly: "1.4", epoch_date_osculation: "2024-11-10T00:00:00Z" } },
    { id: "Sisyphus", name: "1866 Sisyphus", diameter_km: 8.5, material: "S-type", velocity_kms: 15.0, mass_kg: 8e14, close_approach_au: 0.15, orbiting_body: "Sol", is_potentially_hazardous_asteroid: true, predictedImpactDate: "24/11/2071", orbital_data: { semi_major_axis: "1.894", eccentricity: "0.538", inclination: "41.19", ascending_node_longitude: "63.6", perihelion_argument: "292.9", mean_anomaly: "353.3", epoch_date_osculation: "2024-11-10T00:00:00Z" } },
    { id: "Quetzalcoatl", name: "1915 Quetzalcoatl", diameter_km: 0.5, material: "SMASS-type", velocity_kms: 21.0, mass_kg: 2e11, close_approach_au: 0.1, orbiting_body: "Sol", is_potentially_hazardous_asteroid: false, orbital_data: { semi_major_axis: "2.541", eccentricity: "0.571", inclination: "20.42", ascending_node_longitude: "272.0", perihelion_argument: "110.0", mean_anomaly: "356.9", epoch_date_osculation: "2024-11-10T00:00:00Z" } },
    { id: "Boreas", name: "1916 Boreas", diameter_km: 3.5, material: "S-type", velocity_kms: 18.0, mass_kg: 5e13, close_approach_au: 0.06, orbiting_body: "Sol", is_potentially_hazardous_asteroid: false, orbital_data: { semi_major_axis: "2.273", eccentricity: "0.449", inclination: "12.87", ascending_node_longitude: "340.7", perihelion_argument: "336.1", mean_anomaly: "358.8", epoch_date_osculation: "2024-11-10T00:00:00Z" } },
    { id: "Cuyo", name: "1917 Cuyo", diameter_km: 2.3, material: "S-type", velocity_kms: 19.5, mass_kg: 1.5e13, close_approach_au: 0.08, orbiting_body: "Sol", is_potentially_hazardous_asteroid: false, orbital_data: { semi_major_axis: "2.150", eccentricity: "0.505", inclination: "23.94", ascending_node_longitude: "199.7", perihelion_argument: "164.9", mean_anomaly: "353.9", epoch_date_osculation: "2024-11-10T00:00:00Z" } },
    { id: "Anteros", name: "1943 Anteros", diameter_km: 2.3, material: "S-type", velocity_kms: 15.0, mass_kg: 1.5e13, close_approach_au: 0.05, orbiting_body: "Sol", is_potentially_hazardous_asteroid: true, predictedImpactDate: "05/12/2074", orbital_data: { semi_major_axis: "1.430", eccentricity: "0.256", inclination: "8.70", ascending_node_longitude: "246.7", perihelion_argument: "299.1", mean_anomaly: "358.4", epoch_date_osculation: "2024-11-10T00:00:00Z" } },
    { id: "Tezcatlipoca", name: "1980 Tezcatlipoca", diameter_km: 4.8, material: "S-type", velocity_kms: 17.0, mass_kg: 1.5e14, close_approach_au: 0.09, orbiting_body: "Sol", is_potentially_hazardous_asteroid: false, orbital_data: { semi_major_axis: "1.709", eccentricity: "0.365", inclination: "26.84", ascending_node_longitude: "223.7", perihelion_argument: "118.5", mean_anomaly: "356.2", epoch_date_osculation: "2024-11-10T00:00:00Z" } },
];

function loadCuratedNeos() {
    const impactData = JSON.parse(localStorage.getItem(IMPACT_DATA_KEY)) || {};
    
    const diameters = curatedNeosData.map(n => n.diameter_km);
    const minDiameter = Math.min(...diameters);
    const maxDiameter = Math.max(...diameters);
    
    const minNeoSize = EARTH_RADIUS_UNITS / 5.0;
    const maxNeoSize = EARTH_RADIUS_UNITS / 2.0;

    curatedNeosData.forEach(neoData => {
        const scale = (neoData.diameter_km - minDiameter) / (maxDiameter - minDiameter);
        const size = minNeoSize + scale * (maxNeoSize - minNeoSize);
        addNeoToScene(neoData, size);
    });

    neos.forEach(neo => {
        if (impactData[neo.id]) {
            neo.hasImpacted = true;
            neo.impactDate = new Date(impactData[neo.id]);
        }
    });

    populateNeoSelector();
}

function populateNeoSelector() {
    const selector = document.getElementById('neo-selector');
    selector.innerHTML = `<option value="" data-lang-key="selectNeo">${translations[currentLang].selectNeo}</option>`;
    neos.sort((a, b) => a.name.localeCompare(b.name)).forEach(neo => {
        const option = document.createElement('option');
        option.value = neo.id;
        option.textContent = neo.name;
        if (neo.is_potentially_hazardous_asteroid) {
            option.style.color = 'var(--accent-hazardous)';
        } else {
            option.style.color = 'var(--accent-safe)';
        }
        selector.appendChild(option);
    });
}

// =============================================================================
// INTERFAZ DE USUARIO (UI) Y EVENTOS
// =============================================================================
const apiKeyInput = document.getElementById('api-key-input');
const loadNeosBtn = document.getElementById('load-neos-btn');
const timeButtons = document.querySelectorAll('.time-btn');
const pauseBtn = document.getElementById('pause-btn');
const resumeBtn = document.getElementById('resume-btn');
const datePicker = document.getElementById('date-picker');
const goToDateBtn = document.getElementById('go-to-date-btn');
const goToNeoBtn = document.getElementById('go-to-neo-btn');
const riskBtn = document.getElementById('risk-btn');
const statusMessage = document.getElementById('status-message');
const menuToggleBtn = document.getElementById('menu-toggle-btn');
const controlsPanel = document.getElementById('controls-panel');

function updatePauseButtons(isPaused) {
    pauseBtn.disabled = isPaused;
    resumeBtn.disabled = !isPaused;
}

function showStatusMessage(message) {
    statusMessage.textContent = message;
    statusMessage.style.opacity = 1;
    setTimeout(() => {
        statusMessage.style.opacity = 0;
    }, 5000);
}

loadNeosBtn.addEventListener('click', () => alert("La carga de NEOs desde la API está deshabilitada."));

timeButtons.forEach(btn => {
  btn.addEventListener('click', () => {
    simState.timeScale = parseFloat(btn.dataset.scale);
    timeButtons.forEach(b => b.classList.remove('toggled'));
    btn.classList.add('toggled');
  });
});
document.querySelector('.time-btn[data-scale="1"]').classList.add('toggled');

pauseBtn.addEventListener('click', () => {
  simState.isPaused = true;
  updatePauseButtons(true);
});
resumeBtn.addEventListener('click', () => {
  simState.isPaused = false;
  updatePauseButtons(false);
});

const humanRiskPopup = document.getElementById('human-risk-popup-overlay');
const popupCloseBtn = humanRiskPopup.querySelector('.popup-close-btn');

riskBtn.addEventListener('click', () => {
    humanRiskPopup.style.display = 'flex';
});

popupCloseBtn.addEventListener('click', () => {
    humanRiskPopup.style.display = 'none';
});

humanRiskPopup.addEventListener('click', (event) => {
    if (event.target === humanRiskPopup) {
        humanRiskPopup.style.display = 'none';
    }
});

const maxDate = new Date();
maxDate.setFullYear(maxDate.getFullYear() + 50);
datePicker.max = maxDate.toISOString().split('T')[0];
datePicker.value = new Date().toISOString().split('T')[0];

goToDateBtn.addEventListener('click', () => {
  const targetDate = new Date(datePicker.value);
  if (targetDate) {
    simState.date = targetDate;
    simState.isPaused = true;
    updatePauseButtons(true);
  }
});

goToNeoBtn.addEventListener('click', () => {
    const neoId = document.getElementById('neo-selector').value;
    if (!neoId) return;
    const targetNeo = neos.find(n => n.id === neoId);
    if (targetNeo) {
        selectNeo(targetNeo);
        const offset = new THREE.Vector3(0, targetNeo.mesh.geometry.parameters.radius * 5, targetNeo.mesh.geometry.parameters.radius * 10);
        const targetCamPos = new THREE.Vector3().addVectors(targetNeo.mesh.position, offset);
        
        let t = 0;
        const startPos = camera.position.clone();
        const startTarget = controls.target.clone();
        
        function zoomToNeo() {
            if (t < 1) {
                t += 0.02;
                camera.position.lerpVectors(startPos, targetCamPos, t);
                controls.target.lerpVectors(startTarget, targetNeo.mesh.position, t);
                requestAnimationFrame(zoomToNeo);
            } else {
                controls.target.copy(targetNeo.mesh.position);
            }
        }
        zoomToNeo();
    }
});

menuToggleBtn.addEventListener('click', () => {
    controlsPanel.classList.toggle('expanded');
});

const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();

window.addEventListener('click', (event) => {
  if (event.target.closest('.ui-panel') || event.target.closest('.popup-overlay')) return;
  mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
  mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
  raycaster.setFromCamera(mouse, camera);
  const intersects = raycaster.intersectObjects(neosGroup.children);
  if (intersects.length > 0) {
    const clickedId = intersects[0].object.userData.id;
    const foundNeo = neos.find(neo => neo.id === clickedId);
    if (foundNeo) {
      selectNeo(foundNeo);
    }
  }
});

function selectNeo(neo) {
  if (selectedNeo) {
    selectedNeo.mesh.material.emissiveIntensity = 0;
    selectedNeo.orbitLine.material.color.set(0xffffff);
    selectedNeo.orbitLine.material.opacity = 0.4;
  }
  
  if (impactMarker) {
      earth.remove(impactMarker);
      impactMarker = null;
  }

  selectedNeo = neo;
  if (!selectedNeo.hasImpacted) {
    selectedNeo.mesh.material.emissiveIntensity = 1;
    selectedNeo.orbitLine.material.color.set(0x00ff00);
    selectedNeo.orbitLine.material.opacity = 0.9;
  }

  const massFormatted = neo.mass_kg > 1e12 ? `${(neo.mass_kg / 1e12).toExponential(2)} ${translations[currentLang].trillionTons}` : `${Math.round(neo.mass_kg).toLocaleString()} kg`;
  
  let impactInfo = '';
  if (neo.impactDate) {
      impactInfo = `<div class="info-item hazardous"><span>${translations[currentLang].impactedOn}:</span><span>${neo.impactDate.toLocaleDateString()}</span></div>`;
  } else if (neo.potentialImpactDate) {
      impactInfo = `<div class="info-item hazardous"><span>${translations[currentLang].predictedImpact}:</span><span>${neo.potentialImpactDate.toLocaleDateString()}</span></div>`;
  }

  document.getElementById('neo-name').textContent = neo.name;
  const infoContent = document.getElementById('info-content');
  infoContent.innerHTML = `
    <div class="info-item"><span>${translations[currentLang].infoDiameter}</span><span>${neo.diameter_km.toLocaleString()} km</span></div>
    <div class="info-item"><span>${translations[currentLang].infoMaterial}</span><span>${neo.material}</span></div>
    <div class="info-item"><span>${translations[currentLang].infoVelocity}</span><span>${neo.velocity_kms.toLocaleString()} km/s</span></div>
    <div class="info-item"><span>${translations[currentLang].infoMass}</span><span>${massFormatted}</span></div>
    <div class="info-item"><span>${translations[currentLang].infoDistance}</span><span>${(neo.close_approach_au * 149597870.7).toLocaleString()} km</span></div>
    
    <h2 data-lang-key="infoOrbit">${translations[currentLang].infoOrbit}</h2>
    <div class="info-item"><span>${translations[currentLang].infoOrbiting}</span><span>${neo.orbiting_body}</span></div>
    <div class="info-item"><span>${translations[currentLang].infoSemiMajorAxis}</span><span>${parseFloat(neo.orbital_data.semi_major_axis).toFixed(3)} AU</span></div>
    
    <h2 data-lang-key="infoRisk">${translations[currentLang].infoRisk}</h2>
    <div class="info-item"><span>${translations[currentLang].infoPotentiallyHazardous}</span><span>${neo.is_potentially_hazardous_asteroid ? `<span class="hazardous">${translations[currentLang].yes}</span>` : `<span class="safe">${translations[currentLang].no}</span>`}</span></div>
    ${impactInfo}
  `;
  document.getElementById('info-panel').classList.remove('hidden');
}

function showImpactAlert(neo, impactCoords) {
    const alertBox = document.getElementById('impact-alert');
    alertBox.innerHTML = `${translations[currentLang].alertImpact} ${neo.name}\nLat: ${impactCoords.lat.toFixed(2)}, Lon: ${impactCoords.lon.toFixed(2)}`;
    alertBox.style.display = 'block';

    const direction = new THREE.Vector3().subVectors(camera.position, earth.position).normalize();
    const distance = EARTH_RADIUS_UNITS * 3;
    const newCamPos = new THREE.Vector3().addVectors(earth.position, direction.multiplyScalar(distance));
    
    let t = 0;
    const startPos = camera.position.clone();
    const startTarget = controls.target.clone();
    
    function zoom() {
        if (t < 1) {
            t += 0.02;
            camera.position.lerpVectors(startPos, newCamPos, t);
            controls.target.lerpVectors(startTarget, earth.position, t);
            requestAnimationFrame(zoom);
        }
    }
    zoom();

    setTimeout(() => {
        alertBox.style.display = 'none';
    }, 5000);
}

function createImpactMarker(impactPosition) {
    if (impactMarker) {
        earth.remove(impactMarker);
    }
    const markerGeometry = new THREE.CircleGeometry(EARTH_RADIUS_UNITS * 0.05, 32);
    const markerMaterial = new THREE.MeshBasicMaterial({ color: 0xff0000, side: THREE.DoubleSide });
    impactMarker = new THREE.Mesh(markerGeometry, markerMaterial);
    
    impactMarker.position.copy(impactPosition.multiplyScalar(1.01));
    impactMarker.lookAt(earth.position);
    earth.add(impactMarker);
}

// =============================================================================
// BUCLE DE ANIMACIÓN
// =============================================================================
let lastTime = 0;
function animate(time) {
  requestAnimationFrame(animate);
  const deltaTime = (time - lastTime) * 0.001;
  lastTime = time;

  let elapsedMilliseconds = 0;
  if (!simState.isPaused && deltaTime > 0) {
    elapsedMilliseconds = deltaTime * BASE_SIMULATION_SPEED_DAYS_PER_SEC * simState.timeScale * 86400000;
    simState.date.setTime(simState.date.getTime() + elapsedMilliseconds);
    datePicker.value = simState.date.toISOString().split('T')[0];
  }
  
  const earthPos = getPositionFromOrbitalElements(earthOrbitalElements, simState.date);
  if (earthPos) earth.position.copy(earthPos);
  
  if (!simState.isPaused && elapsedMilliseconds > 0) {
    const dailyRotation = (elapsedMilliseconds / 86400000) * 2 * Math.PI;
    earth.rotation.y += dailyRotation;
  }

  neos.forEach(neo => {
    if (neo.impactDate && simState.date >= neo.impactDate) {
        if (neo.mesh.visible) {
            neo.mesh.visible = false;
            neo.orbitLine.visible = false;
            neo.label.visible = false;
        }
        return;
    } else if (neo.impactDate && simState.date < neo.impactDate) {
        neo.hasImpacted = false;
        neo.impactDate = null;
        const impactData = JSON.parse(localStorage.getItem(IMPACT_DATA_KEY)) || {};
        delete impactData[neo.id];
        localStorage.setItem(IMPACT_DATA_KEY, JSON.stringify(impactData));
    }
    
    if (!neo.mesh.visible) {
        neo.mesh.visible = true;
        neo.orbitLine.visible = true;
        neo.label.visible = true;
    }

    const pos = getPositionFromOrbitalElements(neo.orbital_data, simState.date);
    if (pos) {
        neo.mesh.position.copy(pos);
        
        if (!neo.hasImpacted) {
            const distanceToEarth = pos.distanceTo(earth.position);
            if (distanceToEarth < EARTH_RADIUS_UNITS + neo.mesh.geometry.parameters.radius) {
                neo.hasImpacted = true;
                neo.impactDate = new Date(simState.date);
                
                const impactData = JSON.parse(localStorage.getItem(IMPACT_DATA_KEY)) || {};
                impactData[neo.id] = neo.impactDate.toISOString();
                localStorage.setItem(IMPACT_DATA_KEY, JSON.stringify(impactData));

                simState.isPaused = true;
                updatePauseButtons(true);

                const lat = (Math.random() * 180 - 90);
                const lon = (Math.random() * 360 - 180);
                const impactPointLocal = neo.mesh.position.clone().sub(earth.position).normalize().multiplyScalar(EARTH_RADIUS_UNITS);
                
                showImpactAlert(neo, { lat, lon });
                createImpactMarker(impactPointLocal);
                
                if (selectedNeo && selectedNeo.id === neo.id) {
                    selectNeo(neo);
                }
            }
        }
    }
  });
  
  controls.update();
  renderer.render(scene, camera);
  labelRenderer.render(scene, camera);
}

// =============================================================================
// LÓGICA DE TRADUCCIÓN
// =============================================================================
const langSwitchBtn = document.getElementById('lang-switch-btn');
let currentLang = 'es';

const translations = {
    es: {
        title: "Visor de Órbitas NEO",
        docTitle: "Visor de Órbitas NEO 3D (Versión Definitiva)",
        apiKeyPlaceholder: "Pega tu clave de API de la NASA aquí",
        loadNeos: "Cargar NEOs Recientes",
        speed: "Velocidad",
        control: "Control",
        goToDate: "Ir a Fecha",
        goToNeo: "Ir a NEO",
        go: "Ir",
        selectNeo: "Selecciona un NEO",
        humanRisk: "Riesgo Humano",
        langSwitch: "English Version",
        sun: "Sol",
        earth: "Tierra",
        infoDiameter: "Diámetro",
        infoMaterial: "Material",
        infoVelocity: "Velocidad",
        infoMass: "Masa",
        infoDistance: "Distancia Próx. Acerc.",
        infoOrbit: "Órbita",
        infoOrbiting: "Cuerpo que orbita",
        infoSemiMajorAxis: "Eje Semi-Mayor",
        infoRisk: "Riesgo",
        infoPotentiallyHazardous: "Potencialmente Peligroso",
        yes: "SÍ",
        no: "NO",
        impactedOn: "Impactó en",
        predictedImpact: "Impacto Previsto",
        trillionTons: "billones de T",
        alertImpact: "ALERTA: Impacto de",
        popupTitle: "Riesgo Humano: Casos Documentados",
        popupHodgesTitle: "1. Ann Hodges — Sylacauga, Alabama (Estados Unidos, 1954)",
        popupHodgesP1: "El caso más emblemático y científicamente documentado es el de Ann Elizabeth Fowler Hodges, una mujer de 34 años que fue golpeada por un meteorito el 30 de noviembre de 1954 en Sylacauga, Alabama.",
        popupHodgesP2: "El meteorito —una condrita ordinaria tipo H4 de 3,8 kilogramos— atravesó el techo de su casa, rebotó en un mueble y la impactó en el muslo izquierdo y el costado del abdomen, causándole un hematoma severo.",
        popupHodgesP3: "Afortunadamente, Ann sobrevivió, convirtiéndose en la única persona confirmada por la NASA y el Smithsonian que ha sido golpeada directamente por un meteorito.",
        popupHodgesP4: "Este caso fue verificado mediante análisis mineralógicos y espectroscópicos del fragmento, hoy conservado en el National Museum of Natural History (EE.UU.). El evento cambió la forma en que los científicos y el público perciben el peligro de los meteoritos pequeños.",
        popupHodgesSrc: "(Fuentes: National Geographic, 2013; Encyclopedia of Alabama; Smithsonian National Museum of Natural History.)",
        popupMbaleTitle: "2. Mbale, Uganda (1992)",
        popupMbaleP1: "El 14 de agosto de 1992, una lluvia de pequeños meteoritos cayó sobre la ciudad de Mbale, en Uganda, luego de que una bola de fuego cruzara el cielo. Uno de los fragmentos, del tamaño de una nuez, golpeó suavemente a una mujer en la cabeza mientras caminaba, sin causarle heridas graves.",
        popupMbaleP2: "Este evento fue estudiado por científicos del Natural History Museum de Londres y registrado en la Meteoritical Bulletin Database. Los análisis demostraron que el material correspondía a una condrita tipo L5, una de las variedades más comunes de meteoritos rocosos.",
        popupMbaleP3: "El caso Mbale es uno de los pocos en los que se ha confirmado que un meteorito pequeño impactó directamente a un ser humano sin consecuencias fatales, reforzando la idea de que estos objetos pueden representar un peligro real incluso en pequeñas escalas.",
        popupMbaleSrc: "(Fuentes: Natural History Museum, London; Meteoritical Bulletin Database, 1992; Jenniskens et al., Meteoritics & Planetary Science.)",
        popupValeraTitle: "3. Valera, Venezuela (1972)",
        popupValeraP1: "En 1972, en la región de Valera (Trujillo, Venezuela), un pequeño meteorito de unos 2 kilogramos cayó en una hacienda rural y golpeó mortalmente a una vaca.",
        popupValeraP2: "El fragmento fue recuperado por los pobladores y posteriormente analizado por expertos del Smithsonian Institution y el Venezuelan Institute for Scientific Research (IVIC), quienes confirmaron que se trataba de una condrita L5, un meteorito de origen asteroidal.",
        popupValeraP3: "Aunque no afectó directamente a una persona, este evento se usa frecuentemente en investigaciones científicas para ilustrar cómo meteoritos pequeños pueden causar daño físico directo, incluso sin generar cráteres o incendios.",
        popupValeraSrc: "(Fuentes: Meteoritical Bulletin Database; Smithsonian Institution Archives, 1973.)",
    },
    en: {
        title: "NEO Orbit Viewer",
        docTitle: "NEO Orbit Viewer 3D (Final Version)",
        apiKeyPlaceholder: "Paste your NASA API key here",
        loadNeos: "Load Recent NEOs",
        speed: "Speed",
        control: "Control",
        goToDate: "Go to Date",
        goToNeo: "Go to NEO",
        go: "Go",
        selectNeo: "Select a NEO",
        humanRisk: "Human Risk",
        langSwitch: "Versión en Español",
        sun: "Sun",
        earth: "Earth",
        infoDiameter: "Diameter",
        infoMaterial: "Material",
        infoVelocity: "Velocity",
        infoMass: "Mass",
        infoDistance: "Next Approach Dist.",
        infoOrbit: "Orbit",
        infoOrbiting: "Orbiting Body",
        infoSemiMajorAxis: "Semi-Major Axis",
        infoRisk: "Risk",
        infoPotentiallyHazardous: "Potentially Hazardous",
        yes: "YES",
        no: "NO",
        impactedOn: "Impacted on",
        predictedImpact: "Predicted Impact",
        trillionTons: "trillion T",
        alertImpact: "ALERT: Impact of",
        popupTitle: "Human Risk: Documented Cases",
        popupHodgesTitle: "1. Ann Hodges — Sylacauga, Alabama (USA, 1954)",
        popupHodgesP1: "The most emblematic and scientifically documented case is that of Ann Elizabeth Fowler Hodges, a 34-year-old woman who was struck by a meteorite on November 30, 1954, in Sylacauga, Alabama.",
        popupHodgesP2: "The meteorite—a 3.8-kilogram H4 ordinary chondrite—crashed through the roof of her house, bounced off a piece of furniture, and struck her on the left thigh and side of her abdomen, causing a severe bruise.",
        popupHodgesP3: "Fortunately, Ann survived, becoming the only person confirmed by NASA and the Smithsonian to have been directly hit by a meteorite.",
        popupHodgesP4: "This case was verified through mineralogical and spectroscopic analysis of the fragment, now preserved at the National Museum of Natural History (USA). The event changed how scientists and the public perceive the danger of small meteorites.",
        popupHodgesSrc: "(Sources: National Geographic, 2013; Encyclopedia of Alabama; Smithsonian National Museum of Natural History.)",
        popupMbaleTitle: "2. Mbale, Uganda (1992)",
        popupMbaleP1: "On August 14, 1992, a shower of small meteorites fell over the city of Mbale, Uganda, after a fireball streaked across the sky. One of the fragments, the size of a walnut, gently struck a woman on the head as she was walking, causing no serious injuries.",
        popupMbaleP2: "This event was studied by scientists from the Natural History Museum in London and recorded in the Meteoritical Bulletin Database. The analysis showed that the material was an L5 chondrite, one of the most common types of stony meteorites.",
        popupMbaleP3: "The Mbale case is one of the few in which a small meteorite has been confirmed to have directly impacted a human without fatal consequences, reinforcing the idea that these objects can pose a real danger even on small scales.",
        popupMbaleSrc: "(Sources: Natural History Museum, London; Meteoritical Bulletin Database, 1992; Jenniskens et al., Meteoritics & Planetary Science.)",
        popupValeraTitle: "3. Valera, Venezuela (1972)",
        popupValeraP1: "In 1972, in the Valera region (Trujillo, Venezuela), a small meteorite of about 2 kilograms fell on a rural farm and fatally struck a cow.",
        popupValeraP2: "The fragment was recovered by the locals and later analyzed by experts from the Smithsonian Institution and the Venezuelan Institute for Scientific Research (IVIC), who confirmed it was an L5 chondrite, a meteorite of asteroidal origin.",
        popupValeraP3: "Although it did not directly affect a person, this event is frequently used in scientific research to illustrate how small meteorites can cause direct physical damage, even without creating craters or fires.",
        popupValeraSrc: "(Sources: Meteoritical Bulletin Database; Smithsonian Institution Archives, 1973.)",
    }
};

function setLanguage(lang) {
    currentLang = lang;
    localStorage.setItem('preferredLanguage', lang);
    document.documentElement.lang = lang;
    document.title = translations[lang].docTitle;

    document.querySelectorAll('[data-lang-key]').forEach(element => {
        const key = element.dataset.langKey;
        if (translations[lang][key]) {
            if (element.placeholder) {
                element.placeholder = translations[lang][key];
            } else {
                element.textContent = translations[lang][key];
            }
        }
    });

    langSwitchBtn.textContent = translations[lang].langSwitch;
    
    if (selectedNeo) {
        selectNeo(selectedNeo);
    }
}

langSwitchBtn.addEventListener('click', () => {
    const newLang = currentLang === 'es' ? 'en' : 'es';
    setLanguage(newLang);
});

// Iniciar la aplicación
updatePauseButtons(simState.isPaused);
createStarfield();
loadCuratedNeos();
const savedLang = localStorage.getItem('preferredLanguage') || 'es';
setLanguage(savedLang);
animate(0);

</script>
</body>
</html>