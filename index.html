<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Visor de √ìrbitas NEO 3D (Versi√≥n Definitiva)</title>

<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.157.0/examples/jsm/"
  }
}
</script>

<style>
  :root {
    --bg-dark: #02030a;
    --panel-bg: rgba(8, 12, 24, 0.88);
    --text-primary: #e6f0ff;
    --text-muted: #9fb0d8;
    --accent: #ffd07a;
    --accent-hazardous: #ff8a8a;
    --accent-safe: #8aff9e;
    --border-color: rgba(255, 255, 255, 0.05);
  }
  html, body { height: 100%; margin: 0; background: var(--bg-dark); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; color: var(--text-primary); overflow: hidden; }
  #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
  canvas { display: block; }
  .ui-panel { position: absolute; z-index: 10; background: var(--panel-bg); backdrop-filter: blur(6px); border-radius: 12px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid var(--border-color); }
  #controls-panel { top: 15px; left: 15px; width: 380px; }
  #info-panel { top: 15px; right: 15px; width: 380px; max-height: calc(100% - 40px); overflow-y: auto; }
  #info-panel.hidden { display: none; }
  .close-btn { position: absolute; top: 10px; right: 10px; background: none; border: none; color: var(--text-muted); font-size: 20px; cursor: pointer; }
  h1 { font-size: 20px; margin: 0 0 16px 0; color: var(--text-primary); }
  h2 { font-size: 16px; margin: 16px 0 8px 0; color: var(--accent); border-bottom: 1px solid var(--border-color); padding-bottom: 6px; }
  .row { display: flex; gap: 8px; align-items: center; margin-bottom: 10px; }
  .row label { min-width: 70px; color: var(--text-muted); font-size: 14px; }
  button, input, select { background: rgba(255,255,255,0.04); border: 1px solid var(--border-color); color: var(--text-primary); padding: 8px 12px; border-radius: 8px; cursor: pointer; font-family: inherit; font-size: 14px; }
  select { flex: 1; }
  button:hover, select:hover { background: rgba(255,255,255,0.08); }
  button.toggled { outline: 2px solid var(--accent); background: rgba(255, 208, 122, 0.1); }
  button:disabled { opacity: 0.4; cursor: not-allowed; }
  input[type="text"], input[type="date"] { flex: 1; }
  #info-content .info-item { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 6px; padding: 4px 0; }
  #info-content .info-item span:first-child { color: var(--text-muted); }
  #info-content .info-item span:last-child { font-weight: 600; text-align: right; }
  .hazardous { color: var(--accent-hazardous) !important; }
  .safe { color: var(--accent-safe) !important; }
  #footer { position: absolute; bottom: 15px; left: 15px; color: var(--text-muted); font-size: 12px; }
  a { color: var(--accent); text-decoration: none; }
  .label { color: #fff; font-family: sans-serif; padding: 2px; background: rgba(0, 0, 0, 0.6); border-radius: 4px; font-size: 12px; }
  #status-message { font-size: 12px; color: var(--text-muted); margin-top: 10px; height: 16px; transition: opacity 0.5s; }
  #impact-alert { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255, 0, 0, 0.8); color: white; padding: 20px; border-radius: 10px; z-index: 100; display: none; text-align: center; font-size: 1.5em; white-space: pre; }
  
  /* *** NUEVO: Estilos para el Pop-up *** */
  .popup-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
    z-index: 1000;
    display: none; /* Oculto por defecto */
    justify-content: center;
    align-items: center;
  }
  .popup-content {
    position: relative;
    background: var(--panel-bg);
    padding: 25px;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    width: 90%;
    max-width: 700px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 10px 40px rgba(0,0,0,0.6);
  }
  .popup-close-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    background: none;
    border: none;
    color: var(--text-muted);
    font-size: 24px;
    cursor: pointer;
    line-height: 1;
    padding: 5px;
  }
  .popup-content h1 {
    color: var(--accent);
    margin-top: 0;
    font-size: 1.5em;
  }
  .popup-content h2 {
    font-size: 1.1em;
    color: var(--text-primary);
    border-bottom: none;
    padding-bottom: 0;
    margin-bottom: 10px;
  }
  .popup-content p {
    font-size: 0.9em;
    line-height: 1.6;
    color: var(--text-muted);
    margin-bottom: 10px;
  }
  .popup-content small {
    font-size: 0.8em;
    color: var(--text-muted);
    opacity: 0.7;
  }
  .popup-divider {
    border: none;
    border-top: 1px solid var(--border-color);
    margin: 20px 0;
  }

  @media (max-width: 800px) { .ui-panel { width: calc(100% - 30px); } #info-panel { top: auto; bottom: 15px; right: 15px; } }
</style>
</head>
<body>

  <div id="canvas-container"></div>
  <div id="controls-panel" class="ui-panel">
    <h1>Visor de √ìrbitas NEO</h1>
    <div class="row">
      <input id="api-key-input" type="text" placeholder="Pega tu clave de API de la NASA aqu√≠">
      <button id="load-neos-btn">Cargar NEOs Recientes</button>
    </div>
    <div id="status-message"></div>
    <hr style="border:none; border-top:1px solid var(--border-color); margin: 16px 0;"/>
    <div class="row">
      <label>Velocidad</label>
      <button class="time-btn" data-scale="1">1x</button>
      <button class="time-btn" data-scale="5">5x</button>
      <button class="time-btn" data-scale="10">10x</button>
      <button class="time-btn" data-scale="20">20x</button>
      <button class="time-btn" data-scale="100">100x</button>
    </div>
    <div class="row">
      <label>Control</label>
      <button id="resume-btn" title="Reanudar">‚ñ∂</button>
      <button id="pause-btn" title="Pausar">||</button>
    </div>
    <div class="row">
      <label for="date-picker">Ir a Fecha</label>
      <input type="date" id="date-picker">
      <button id="go-to-date-btn">Ir</button>
    </div>
    <div class="row">
        <label for="neo-selector">Ir a NEO</label>
        <select id="neo-selector">
            <option value="">Selecciona un NEO</option>
        </select>
        <button id="go-to-neo-btn">Ir</button>
    </div>
  </div>
  <div id="info-panel" class="ui-panel hidden">
    <button class="close-btn" onclick="document.getElementById('info-panel').classList.add('hidden')">&times;</button>
    <h2 id="neo-name"></h2>
    <div id="info-content"></div>
  </div>
  <div id="footer">
    <button id="risk-btn" style="padding: 4px 8px; font-size: 12px;">Riesgo Humano</button>
  </div>
  <div id="impact-alert"></div>

  <!-- *** NUEVO: Contenido del Pop-up *** -->
  <div id="human-risk-popup-overlay" class="popup-overlay">
    <div class="popup-content">
      <button class="popup-close-btn">&times;</button>
      <h1>Riesgo Humano: Casos Documentados</h1>
      <div class="news-item">
        <h2>ü™® 1. Ann Hodges ‚Äî Sylacauga, Alabama (Estados Unidos, 1954)</h2>
        <p>El caso m√°s emblem√°tico y cient√≠ficamente documentado es el de Ann Elizabeth Fowler Hodges, una mujer de 34 a√±os que fue golpeada por un meteorito el 30 de noviembre de 1954 en Sylacauga, Alabama.</p>
        <p>El meteorito ‚Äîuna condrita ordinaria tipo H4 de 3,8 kilogramos‚Äî atraves√≥ el techo de su casa, rebot√≥ en un mueble y la impact√≥ en el muslo izquierdo y el costado del abdomen, caus√°ndole un hematoma severo.</p>
        <p>Afortunadamente, Ann sobrevivi√≥, convirti√©ndose en la √∫nica persona confirmada por la NASA y el Smithsonian que ha sido golpeada directamente por un meteorito.</p>
        <p>Este caso fue verificado mediante an√°lisis mineral√≥gicos y espectrosc√≥picos del fragmento, hoy conservado en el National Museum of Natural History (EE.UU.). El evento cambi√≥ la forma en que los cient√≠ficos y el p√∫blico perciben el peligro de los meteoritos peque√±os.</p>
        <small>(Fuentes: National Geographic, 2013; Encyclopedia of Alabama; Smithsonian National Museum of Natural History.)</small>
      </div>
      <hr class="popup-divider">
      <div class="news-item">
        <h2>üë£ 2. Mbale, Uganda (1992)</h2>
        <p>El 14 de agosto de 1992, una lluvia de peque√±os meteoritos cay√≥ sobre la ciudad de Mbale, en Uganda, luego de que una bola de fuego cruzara el cielo. Uno de los fragmentos, del tama√±o de una nuez, golpe√≥ suavemente a una mujer en la cabeza mientras caminaba, sin causarle heridas graves.</p>
        <p>Este evento fue estudiado por cient√≠ficos del Natural History Museum de Londres y registrado en la Meteoritical Bulletin Database. Los an√°lisis demostraron que el material correspond√≠a a una condrita tipo L5, una de las variedades m√°s comunes de meteoritos rocosos.</p>
        <p>El caso Mbale es uno de los pocos en los que se ha confirmado que un meteorito peque√±o impact√≥ directamente a un ser humano sin consecuencias fatales, reforzando la idea de que estos objetos pueden representar un peligro real incluso en peque√±as escalas.</p>
        <small>(Fuentes: Natural History Museum, London; Meteoritical Bulletin Database, 1992; Jenniskens et al., Meteoritics & Planetary Science.)</small>
      </div>
      <hr class="popup-divider">
      <div class="news-item">
        <h2>üêÑ 3. Valera, Venezuela (1972)</h2>
        <p>En 1972, en la regi√≥n de Valera (Trujillo, Venezuela), un peque√±o meteorito de unos 2 kilogramos cay√≥ en una hacienda rural y golpe√≥ mortalmente a una vaca.</p>
        <p>El fragmento fue recuperado por los pobladores y posteriormente analizado por expertos del Smithsonian Institution y el Venezuelan Institute for Scientific Research (IVIC), quienes confirmaron que se trataba de una condrita L5, un meteorito de origen asteroidal.</p>
        <p>Aunque no afect√≥ directamente a una persona, este evento se usa frecuentemente en investigaciones cient√≠ficas para ilustrar c√≥mo meteoritos peque√±os pueden causar da√±o f√≠sico directo, incluso sin generar cr√°teres o incendios.</p>
        <small>(Fuentes: Meteoritical Bulletin Database; Smithsonian Institution Archives, 1973.)</small>
      </div>
    </div>
  </div>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { CSS2DRenderer, CSS2DObject } from 'three/addons/renderers/CSS2DRenderer.js';

// =============================================================================
// CONFIGURACI√ìN INICIAL
// =============================================================================
const AU_TO_UNITS = 150;
const EARTH_RADIUS_UNITS = 0.02 * AU_TO_UNITS * 4.0;
const GAUSS_K = 0.01720209895;
const BASE_SIMULATION_SPEED_DAYS_PER_SEC = 1;
const IMPACT_DATA_KEY = 'neoImpactData';

// =============================================================================
// INICIALIZACI√ìN DE LA ESCENA 3D Y RENDERERS
// =============================================================================
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 50000);
camera.position.set(1.5 * AU_TO_UNITS, 1.5 * AU_TO_UNITS, 2.5 * AU_TO_UNITS);

const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(window.devicePixelRatio);
document.getElementById('canvas-container').appendChild(renderer.domElement);

const labelRenderer = new CSS2DRenderer();
labelRenderer.setSize(window.innerWidth, window.innerHeight);
labelRenderer.domElement.style.position = 'absolute';
labelRenderer.domElement.style.top = '0px';
labelRenderer.domElement.style.pointerEvents = 'none';
document.getElementById('canvas-container').appendChild(labelRenderer.domElement);

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.dampingFactor = 0.05;
controls.target.set(0, 0, 0);
controls.mouseButtons = { LEFT: THREE.MOUSE.PAN, MIDDLE: THREE.MOUSE.DOLLY, RIGHT: THREE.MOUSE.ROTATE };

window.addEventListener('resize', () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
  labelRenderer.setSize(window.innerWidth, window.innerHeight);
});

// =============================================================================
// ELEMENTOS DE LA ESCENA (ESTRELLAS, SOL, TIERRA)
// =============================================================================
function createStarfield() {
    const vertices = [];
    for (let i = 0; i < 10000; i++) {
        const x = THREE.MathUtils.randFloatSpread(40000);
        const y = THREE.MathUtils.randFloatSpread(40000);
        const z = THREE.MathUtils.randFloatSpread(40000);
        vertices.push(x, y, z);
    }
    const geometry = new THREE.BufferGeometry();
    geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
    const material = new THREE.PointsMaterial({ color: 0x888888, size: 2, sizeAttenuation: false });
    const stars = new THREE.Points(geometry, material);
    scene.add(stars);
}

const textureLoader = new THREE.TextureLoader();
const meteorTexture = textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/moon_1024.jpg');

function createLabel(text) {
  const div = document.createElement('div');
  div.className = 'label';
  div.textContent = text;
  return new CSS2DObject(div);
}

const sunTexture = textureLoader.load('https://raw.githubusercontent.com/jeromeetienne/threex.planets/master/images/sunmap.jpg');
const sun = new THREE.Mesh(
  new THREE.SphereGeometry(0.1 * AU_TO_UNITS, 64, 64),
  new THREE.MeshBasicMaterial({ map: sunTexture })
);
const sunLabel = createLabel('Sol');
sunLabel.position.set(0, 0.1 * AU_TO_UNITS, 0);
sun.add(sunLabel);
scene.add(sun);

const sunLight = new THREE.PointLight(0xffffff, 1.5, 0, 0);
scene.add(sunLight);
scene.add(new THREE.AmbientLight(0xffffff, 0.1));

const earthTexture = textureLoader.load('https://raw.githubusercontent.com/jeromeetienne/threex.planets/master/images/earthmap1k.jpg');
const earth = new THREE.Mesh(
  new THREE.SphereGeometry(EARTH_RADIUS_UNITS, 32, 32),
  new THREE.MeshPhongMaterial({ map: earthTexture })
);
const earthLabel = createLabel('Tierra');
earthLabel.position.set(0, EARTH_RADIUS_UNITS * 1.5, 0);
earth.add(earthLabel);
scene.add(earth);

let impactMarker = null;

const orbitsGroup = new THREE.Group();
const neosGroup = new THREE.Group();
scene.add(orbitsGroup, neosGroup);

// =============================================================================
// L√ìGICA ORBITAL
// =============================================================================
const deg2rad = (d) => d * Math.PI / 180;

function solveKepler(meanAnomaly, eccentricity, tolerance = 1e-9) {
  let E = meanAnomaly;
  let delta = 1;
  for (let i = 0; i < 100 && Math.abs(delta) > tolerance; i++) {
    delta = (E - eccentricity * Math.sin(E) - meanAnomaly) / (1 - eccentricity * Math.cos(E));
    E -= delta;
  }
  return E;
}

function getPositionFromOrbitalElements(elements, date) {
  const a = parseFloat(elements.semi_major_axis);
  const e = parseFloat(elements.eccentricity);
  const i = deg2rad(parseFloat(elements.inclination));
  const Omega = deg2rad(parseFloat(elements.ascending_node_longitude));
  const omega = deg2rad(parseFloat(elements.perihelion_argument));
  const M0 = deg2rad(parseFloat(elements.mean_anomaly));
  const epoch = new Date(elements.epoch_date_osculation).getTime();

  if ([a, e, i, Omega, omega, M0, epoch].some(isNaN)) {
    return null;
  }

  const timeSinceEpoch = (date.getTime() - epoch) / (1000 * 60 * 60 * 24);
  const meanMotion = GAUSS_K / Math.sqrt(a * a * a);
  const meanAnomaly = M0 + meanMotion * timeSinceEpoch;
  const eccentricAnomaly = solveKepler(meanAnomaly, e);
  const x_orb = a * (Math.cos(eccentricAnomaly) - e);
  const y_orb = a * Math.sqrt(1 - e * e) * Math.sin(eccentricAnomaly);
  const cosO = Math.cos(Omega), sinO = Math.sin(Omega);
  const cosw = Math.cos(omega), sinw = Math.sin(omega);
  const cosi = Math.cos(i), sini = Math.sin(i);
  const x = (cosO * cosw - sinO * sinw * cosi) * x_orb + (-cosO * sinw - sinO * cosw * cosi) * y_orb;
  const y = (sinO * cosw + cosO * sinw * cosi) * x_orb + (-sinO * sinw + cosO * cosw * cosi) * y_orb;
  const z = (sinw * sini) * x_orb + (cosw * sini) * y_orb;
  return new THREE.Vector3(x, z, -y).multiplyScalar(AU_TO_UNITS);
}

// =============================================================================
// MANEJO DE DATOS Y OBJETOS
// =============================================================================
let neos = [];
let selectedNeo = null;
let simState = { date: new Date(), timeScale: 1, isPaused: false };

const earthOrbitalElements = {
  semi_major_axis: "1.00000011",
  eccentricity: "0.01671022",
  inclination: "0.00005",
  ascending_node_longitude: "-11.26064",
  perihelion_argument: "102.94719",
  mean_anomaly: "100.46435",
  epoch_date_osculation: "2000-01-01T12:00:00Z"
};

function createOrbitLine(elements, color = 0xffffff) {
    const points = [];
    const epochDate = new Date(elements.epoch_date_osculation);
    for (let i = 0; i <= 360; i++) {
        const tempElements = { ...elements, mean_anomaly: i };
        const pos = getPositionFromOrbitalElements(tempElements, epochDate);
        if (pos) points.push(pos);
    }
    if (points.length < 2) return null;
    const geometry = new THREE.BufferGeometry().setFromPoints(points);
    const material = new THREE.LineBasicMaterial({ color, transparent: true, opacity: 0.4 });
    return new THREE.Line(geometry, material);
}

const earthOrbitLine = createOrbitLine(earthOrbitalElements, 0x6699ff);
if (earthOrbitLine) orbitsGroup.add(earthOrbitLine);

function clearAllNeos() {
  neos.forEach(neo => {
    if (neo.mesh) neosGroup.remove(neo.mesh);
    if (neo.orbitLine) orbitsGroup.remove(neo.orbitLine);
    if (neo.label) neo.mesh.remove(neo.label);
  });
  neos = [];
  selectedNeo = null;
  document.getElementById('info-panel').classList.add('hidden');
  document.getElementById('neo-selector').innerHTML = '<option value="">Selecciona un NEO</option>';
}

function addNeoToScene(neoData, size) {
  if (!neoData.orbital_data || getPositionFromOrbitalElements(neoData.orbital_data, new Date()) === null) {
    console.warn(`Datos orbitales inv√°lidos o incompletos para el NEO: ${neoData.name}. Se omitir√°.`);
    return false;
  }

  const isHazardous = neoData.is_potentially_hazardous_asteroid;
  
  const material = new THREE.MeshPhongMaterial({
    map: meteorTexture,
    emissive: isHazardous ? 0xff0000 : 0xffff00,
    emissiveIntensity: 0
  });
  
  const geometry = new THREE.SphereGeometry(size, 16, 16);
  const mesh = new THREE.Mesh(geometry, material);
  
  const orbitLine = createOrbitLine(neoData.orbital_data);
  if (!orbitLine) return false;

  const label = createLabel(neoData.name);
  label.position.set(0, size * 1.5, 0);
  label.visible = true;
  mesh.add(label);
  
  mesh.userData = { id: neoData.id };
  neosGroup.add(mesh);
  orbitsGroup.add(orbitLine);
  
  const neoObject = { ...neoData, mesh, orbitLine, label, hasImpacted: false, impactDate: null };
  
  if (neoData.predictedImpactDate) {
      const [day, month, year] = neoData.predictedImpactDate.split('/');
      neoObject.potentialImpactDate = new Date(year, month - 1, day);
  }

  neos.push(neoObject);
  return true;
}

// =============================================================================
// DATOS CURADOS Y CONEXI√ìN CON LA API
// =============================================================================
const curatedNeosData = [
    { id: "Eros", name: "433 Eros", diameter_km: 16.8, material: "S-type (rocoso)", velocity_kms: 5.5, mass_kg: 6.687e15, close_approach_au: 0.1498, orbiting_body: "Sol", is_potentially_hazardous_asteroid: true, predictedImpactDate: "24/01/2056", orbital_data: { semi_major_axis: "1.458", eccentricity: "0.223", inclination: "10.829", ascending_node_longitude: "304.3", perihelion_argument: "178.6", mean_anomaly: "212.8", epoch_date_osculation: "2023-01-01T00:00:00Z" } },
    { id: "Albert", name: "719 Albert", diameter_km: 2.5, material: "S-like (rocoso)", velocity_kms: 18.38, mass_kg: 2e13, close_approach_au: 0.205, orbiting_body: "Sol", is_potentially_hazardous_asteroid: false, orbital_data: { semi_major_axis: "2.633", eccentricity: "0.548", inclination: "11.57", ascending_node_longitude: "183.85", perihelion_argument: "155.8", mean_anomaly: "16.9", epoch_date_osculation: "2024-11-10T00:00:00Z" } },
    { id: "Alinda", name: "887 Alinda", diameter_km: 4, material: "S-type (rocoso)", velocity_kms: 18.94, mass_kg: 1e14, close_approach_au: 0.095, orbiting_body: "Sol", is_potentially_hazardous_asteroid: false, orbital_data: { semi_major_axis: "2.475", eccentricity: "0.567", inclination: "9.39", ascending_node_longitude: "110.6", perihelion_argument: "350.1", mean_anomaly: "11.3", epoch_date_osculation: "2024-11-10T00:00:00Z" } },
    { id: "Ganymed", name: "1036 Ganymed", diameter_km: 35, material: "S-type (rocoso)", velocity_kms: 14.3, mass_kg: 7e16, close_approach_au: 0.359, orbiting_body: "Sol", is_potentially_hazardous_asteroid: false, orbital_data: { semi_major_axis: "2.663", eccentricity: "0.533", inclination: "26.69", ascending_node_longitude: "215.5", perihelion_argument: "132.4", mean_anomaly: "343.5", epoch_date_osculation: "2024-11-10T00:00:00Z" } },
    { id: "Amor", name: "1221 Amor", diameter_km: 1.5, material: "S-type (silic√°ceo)", velocity_kms: 14.5, mass_kg: 2e12, close_approach_au: 0.1069, orbiting_body: "Sol", is_potentially_hazardous_asteroid: false, orbital_data: { semi_major_axis: "1.919", eccentricity: "0.435", inclination: "11.88", ascending_node_longitude: "171.3", perihelion_argument: "26.4", mean_anomaly: "357.2", epoch_date_osculation: "2024-11-10T00:00:00Z" } },
    { id: "Icarus", name: "1566 Icarus", diameter_km: 1.2, material: "S-type (rocoso)", velocity_kms: 21.3, mass_kg: 3.9e12, close_approach_au: 0.04248, orbiting_body: "Sol", is_potentially_hazardous_asteroid: true, predictedImpactDate: "11/06/2068", orbital_data: { semi_major_axis: "1.078", eccentricity: "0.827", inclination: "22.84", ascending_node_longitude: "88.0", perihelion_argument: "31.2", mean_anomaly: "176.4", epoch_date_osculation: "2024-11-10T00:00:00Z" } },
    { id: "Betulia", name: "1580 Betulia", diameter_km: 4.2, material: "C-type (oscuro)", velocity_kms: 20.1, mass_kg: 2e14, close_approach_au: 0.0406, orbiting_body: "Sol", is_potentially_hazardous_asteroid: false, orbital_data: { semi_major_axis: "2.196", eccentricity: "0.489", inclination: "52.08", ascending_node_longitude: "62.2", perihelion_argument: "159.4", mean_anomaly: "339.3", epoch_date_osculation: "2024-11-10T00:00:00Z" } },
    { id: "Geographos", name: "1620 Geographos", diameter_km: 2.55, material: "S-type (rocoso)", velocity_kms: 25.2, mass_kg: 2.4e13, close_approach_au: 0.0301, orbiting_body: "Sol", is_potentially_hazardous_asteroid: true, predictedImpactDate: "25/08/2088", orbital_data: { semi_major_axis: "1.245", eccentricity: "0.335", inclination: "13.33", ascending_node_longitude: "337.2", perihelion_argument: "276.8", mean_anomaly: "3.9", epoch_date_osculation: "2024-11-10T00:00:00Z" } },
    { id: "Ivar", name: "1627 Ivar", diameter_km: 7.75, material: "S-type (silic√°ceo)", velocity_kms: 22.6, mass_kg: 8e14, close_approach_au: 0.110963, orbiting_body: "Sol", is_potentially_hazardous_asteroid: false, orbital_data: { semi_major_axis: "1.863", eccentricity: "0.397", inclination: "8.45", ascending_node_longitude: "132.8", perihelion_argument: "169.6", mean_anomaly: "350.1", epoch_date_osculation: "2024-11-10T00:00:00Z" } },
    { id: "Toro", name: "1685 Toro", diameter_km: 3.5, material: "S-type (silic√°ceo)", velocity_kms: 24.4, mass_kg: 5.6e13, close_approach_au: 0.0520, orbiting_body: "Sol", is_potentially_hazardous_asteroid: true, predictedImpactDate: "08/08/2045", orbital_data: { semi_major_axis: "1.367", eccentricity: "0.436", inclination: "9.38", ascending_node_longitude: "274.4", perihelion_argument: "127.1", mean_anomaly: "31.2", epoch_date_osculation: "2024-11-10T00:00:00Z" } },
    { id: "Apollo", name: "1862 Apollo", diameter_km: 1.5, material: "Q-type", velocity_kms: 20.0, mass_kg: 4e12, close_approach_au: 0.025, orbiting_body: "Sol", is_potentially_hazardous_asteroid: true, predictedImpactDate: "28/05/2075", orbital_data: { semi_major_axis: "1.470", eccentricity: "0.560", inclination: "6.35", ascending_node_longitude: "35.8", perihelion_argument: "285.7", mean_anomaly: "356.9", epoch_date_osculation: "2024-11-10T00:00:00Z" } },
    { id: "Antinous", name: "1863 Antinous", diameter_km: 2.1, material: "S-type", velocity_kms: 19.0, mass_kg: 1.2e13, close_approach_au: 0.2, orbiting_body: "Sol", is_potentially_hazardous_asteroid: false, orbital_data: { semi_major_axis: "2.259", eccentricity: "0.606", inclination: "18.39", ascending_node_longitude: "346.4", perihelion_argument: "247.1", mean_anomaly: "349.8", epoch_date_osculation: "2024-11-10T00:00:00Z" } },
    { id: "Daedalus", name: "1864 Daedalus", diameter_km: 3.0, material: "S-type", velocity_kms: 25.0, mass_kg: 3e13, close_approach_au: 0.03, orbiting_body: "Sol", is_potentially_hazardous_asteroid: true, predictedImpactDate: "10/03/2067", orbital_data: { semi_major_axis: "1.461", eccentricity: "0.614", inclination: "22.19", ascending_node_longitude: "11.0", perihelion_argument: "325.5", mean_anomaly: "349.6", epoch_date_osculation: "2024-11-10T00:00:00Z" } },
    { id: "Cerberus", name: "1865 Cerberus", diameter_km: 1.2, material: "S-type", velocity_kms: 22.0, mass_kg: 2.5e12, close_approach_au: 0.1, orbiting_body: "Sol", is_potentially_hazardous_asteroid: true, orbital_data: { semi_major_axis: "1.080", eccentricity: "0.467", inclination: "16.09", ascending_node_longitude: "195.1", perihelion_argument: "325.1", mean_anomaly: "1.4", epoch_date_osculation: "2024-11-10T00:00:00Z" } },
    { id: "Sisyphus", name: "1866 Sisyphus", diameter_km: 8.5, material: "S-type", velocity_kms: 15.0, mass_kg: 8e14, close_approach_au: 0.15, orbiting_body: "Sol", is_potentially_hazardous_asteroid: true, predictedImpactDate: "24/11/2071", orbital_data: { semi_major_axis: "1.894", eccentricity: "0.538", inclination: "41.19", ascending_node_longitude: "63.6", perihelion_argument: "292.9", mean_anomaly: "353.3", epoch_date_osculation: "2024-11-10T00:00:00Z" } },
    { id: "Quetzalcoatl", name: "1915 Quetzalcoatl", diameter_km: 0.5, material: "SMASS-type", velocity_kms: 21.0, mass_kg: 2e11, close_approach_au: 0.1, orbiting_body: "Sol", is_potentially_hazardous_asteroid: false, orbital_data: { semi_major_axis: "2.541", eccentricity: "0.571", inclination: "20.42", ascending_node_longitude: "272.0", perihelion_argument: "110.0", mean_anomaly: "356.9", epoch_date_osculation: "2024-11-10T00:00:00Z" } },
    { id: "Boreas", name: "1916 Boreas", diameter_km: 3.5, material: "S-type", velocity_kms: 18.0, mass_kg: 5e13, close_approach_au: 0.06, orbiting_body: "Sol", is_potentially_hazardous_asteroid: false, orbital_data: { semi_major_axis: "2.273", eccentricity: "0.449", inclination: "12.87", ascending_node_longitude: "340.7", perihelion_argument: "336.1", mean_anomaly: "358.8", epoch_date_osculation: "2024-11-10T00:00:00Z" } },
    { id: "Cuyo", name: "1917 Cuyo", diameter_km: 2.3, material: "S-type", velocity_kms: 19.5, mass_kg: 1.5e13, close_approach_au: 0.08, orbiting_body: "Sol", is_potentially_hazardous_asteroid: false, orbital_data: { semi_major_axis: "2.150", eccentricity: "0.505", inclination: "23.94", ascending_node_longitude: "199.7", perihelion_argument: "164.9", mean_anomaly: "353.9", epoch_date_osculation: "2024-11-10T00:00:00Z" } },
    { id: "Anteros", name: "1943 Anteros", diameter_km: 2.3, material: "S-type", velocity_kms: 15.0, mass_kg: 1.5e13, close_approach_au: 0.05, orbiting_body: "Sol", is_potentially_hazardous_asteroid: true, predictedImpactDate: "17/09/2091", orbital_data: { semi_major_axis: "1.430", eccentricity: "0.256", inclination: "8.70", ascending_node_longitude: "246.7", perihelion_argument: "299.1", mean_anomaly: "358.4", epoch_date_osculation: "2024-11-10T00:00:00Z" } },
    { id: "Tezcatlipoca", name: "1980 Tezcatlipoca", diameter_km: 4.8, material: "S-type", velocity_kms: 17.0, mass_kg: 1.5e14, close_approach_au: 0.09, orbiting_body: "Sol", is_potentially_hazardous_asteroid: false, orbital_data: { semi_major_axis: "1.709", eccentricity: "0.365", inclination: "26.84", ascending_node_longitude: "223.7", perihelion_argument: "118.5", mean_anomaly: "356.2", epoch_date_osculation: "2024-11-10T00:00:00Z" } },
];

function loadCuratedNeos() {
    const impactData = JSON.parse(localStorage.getItem(IMPACT_DATA_KEY)) || {};
    
    const diameters = curatedNeosData.map(n => n.diameter_km);
    const minDiameter = Math.min(...diameters);
    const maxDiameter = Math.max(...diameters);
    
    const minNeoSize = EARTH_RADIUS_UNITS / 5.0;
    const maxNeoSize = EARTH_RADIUS_UNITS / 2.0;

    curatedNeosData.forEach(neoData => {
        const scale = (neoData.diameter_km - minDiameter) / (maxDiameter - minDiameter);
        const size = minNeoSize + scale * (maxNeoSize - minNeoSize);
        addNeoToScene(neoData, size);
    });

    neos.forEach(neo => {
        if (impactData[neo.id]) {
            neo.hasImpacted = true;
            neo.impactDate = new Date(impactData[neo.id]);
        }
    });

    populateNeoSelector();
}

function populateNeoSelector() {
    const selector = document.getElementById('neo-selector');
    selector.innerHTML = '<option value="">Selecciona un NEO</option>';
    neos.sort((a, b) => a.name.localeCompare(b.name)).forEach(neo => {
        const option = document.createElement('option');
        option.value = neo.id;
        option.textContent = neo.name;
        if (neo.is_potentially_hazardous_asteroid) {
            option.style.color = 'var(--accent-hazardous)';
        } else {
            option.style.color = 'var(--accent-safe)';
        }
        selector.appendChild(option);
    });
}

// =============================================================================
// INTERFAZ DE USUARIO (UI) Y EVENTOS
// =============================================================================
const apiKeyInput = document.getElementById('api-key-input');
const loadNeosBtn = document.getElementById('load-neos-btn');
const timeButtons = document.querySelectorAll('.time-btn');
const pauseBtn = document.getElementById('pause-btn');
const resumeBtn = document.getElementById('resume-btn');
const datePicker = document.getElementById('date-picker');
const goToDateBtn = document.getElementById('go-to-date-btn');
const goToNeoBtn = document.getElementById('go-to-neo-btn');
const riskBtn = document.getElementById('risk-btn');
const statusMessage = document.getElementById('status-message');

function updatePauseButtons(isPaused) {
    pauseBtn.disabled = isPaused;
    resumeBtn.disabled = !isPaused;
}

function showStatusMessage(message) {
    statusMessage.textContent = message;
    statusMessage.style.opacity = 1;
    setTimeout(() => {
        statusMessage.style.opacity = 0;
    }, 5000);
}

loadNeosBtn.addEventListener('click', () => alert("La carga de NEOs desde la API est√° deshabilitada."));

timeButtons.forEach(btn => {
  btn.addEventListener('click', () => {
    simState.timeScale = parseFloat(btn.dataset.scale);
    timeButtons.forEach(b => b.classList.remove('toggled'));
    btn.classList.add('toggled');
  });
});
document.querySelector('.time-btn[data-scale="1"]').classList.add('toggled');

pauseBtn.addEventListener('click', () => {
  simState.isPaused = true;
  updatePauseButtons(true);
});
resumeBtn.addEventListener('click', () => {
  simState.isPaused = false;
  updatePauseButtons(false);
});

// *** CAMBIO: L√≥gica del bot√≥n "Riesgo Humano" para abrir el pop-up ***
const humanRiskPopup = document.getElementById('human-risk-popup-overlay');
const popupCloseBtn = humanRiskPopup.querySelector('.popup-close-btn');

riskBtn.addEventListener('click', () => {
    humanRiskPopup.style.display = 'flex';
});

popupCloseBtn.addEventListener('click', () => {
    humanRiskPopup.style.display = 'none';
});

humanRiskPopup.addEventListener('click', (event) => {
    if (event.target === humanRiskPopup) {
        humanRiskPopup.style.display = 'none';
    }
});

const maxDate = new Date();
maxDate.setFullYear(maxDate.getFullYear() + 50);
datePicker.max = maxDate.toISOString().split('T')[0];
datePicker.value = new Date().toISOString().split('T')[0];

goToDateBtn.addEventListener('click', () => {
  const targetDate = new Date(datePicker.value);
  if (targetDate) {
    simState.date = targetDate;
    simState.isPaused = true;
    updatePauseButtons(true);
  }
});

goToNeoBtn.addEventListener('click', () => {
    const neoId = document.getElementById('neo-selector').value;
    if (!neoId) return;
    const targetNeo = neos.find(n => n.id === neoId);
    if (targetNeo) {
        selectNeo(targetNeo);
        const offset = new THREE.Vector3(0, targetNeo.mesh.geometry.parameters.radius * 5, targetNeo.mesh.geometry.parameters.radius * 10);
        const targetCamPos = new THREE.Vector3().addVectors(targetNeo.mesh.position, offset);
        
        let t = 0;
        const startPos = camera.position.clone();
        const startTarget = controls.target.clone();
        
        function zoomToNeo() {
            if (t < 1) {
                t += 0.02;
                camera.position.lerpVectors(startPos, targetCamPos, t);
                controls.target.lerpVectors(startTarget, targetNeo.mesh.position, t);
                requestAnimationFrame(zoomToNeo);
            } else {
                controls.target.copy(targetNeo.mesh.position);
            }
        }
        zoomToNeo();
    }
});

const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();

window.addEventListener('click', (event) => {
  if (event.target.closest('.ui-panel') || event.target.closest('.popup-overlay')) return;
  mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
  mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
  raycaster.setFromCamera(mouse, camera);
  const intersects = raycaster.intersectObjects(neosGroup.children);
  if (intersects.length > 0) {
    const clickedId = intersects[0].object.userData.id;
    const foundNeo = neos.find(neo => neo.id === clickedId);
    if (foundNeo) {
      selectNeo(foundNeo);
    }
  }
});

function selectNeo(neo) {
  if (selectedNeo) {
    selectedNeo.mesh.material.emissiveIntensity = 0;
    selectedNeo.orbitLine.material.color.set(0xffffff);
    selectedNeo.orbitLine.material.opacity = 0.4;
  }
  
  if (impactMarker) {
      earth.remove(impactMarker);
      impactMarker = null;
  }

  selectedNeo = neo;
  if (!selectedNeo.hasImpacted) {
    selectedNeo.mesh.material.emissiveIntensity = 1;
    selectedNeo.orbitLine.material.color.set(0x00ff00);
    selectedNeo.orbitLine.material.opacity = 0.9;
  }

  const massFormatted = neo.mass_kg > 1e12 ? `${(neo.mass_kg / 1e12).toExponential(2)} billones de T` : `${Math.round(neo.mass_kg).toLocaleString()} kg`;
  
  let impactInfo = '';
  if (neo.impactDate) {
      impactInfo = `<div class="info-item hazardous"><span>Impact√≥ en:</span><span>${neo.impactDate.toLocaleDateString()}</span></div>`;
  } else if (neo.potentialImpactDate) {
      impactInfo = `<div class="info-item hazardous"><span>Impacto Previsto:</span><span>${neo.potentialImpactDate.toLocaleDateString()}</span></div>`;
  }

  document.getElementById('neo-name').textContent = neo.name;
  const infoContent = document.getElementById('info-content');
  infoContent.innerHTML = `
    <div class="info-item"><span>Di√°metro</span><span>${neo.diameter_km.toLocaleString()} km</span></div>
    <div class="info-item"><span>Material</span><span>${neo.material}</span></div>
    <div class="info-item"><span>Velocidad</span><span>${neo.velocity_kms.toLocaleString()} km/s</span></div>
    <div class="info-item"><span>Masa</span><span>${massFormatted}</span></div>
    <div class="info-item"><span>Distancia Pr√≥x. Acerc.</span><span>${(neo.close_approach_au * 149597870.7).toLocaleString()} km</span></div>
    
    <h2>√ìrbita</h2>
    <div class="info-item"><span>Cuerpo que orbita</span><span>${neo.orbiting_body}</span></div>
    <div class="info-item"><span>Eje Semi-Mayor</span><span>${parseFloat(neo.orbital_data.semi_major_axis).toFixed(3)} AU</span></div>
    
    <h2>Riesgo</h2>
    <div class="info-item"><span>Potencialmente Peligroso</span><span>${neo.is_potentially_hazardous_asteroid ? '<span class="hazardous">S√ç</span>' : '<span class="safe">NO</span>'}</span></div>
    ${impactInfo}
  `;
  document.getElementById('info-panel').classList.remove('hidden');
}

function showImpactAlert(neo, impactCoords) {
    const alertBox = document.getElementById('impact-alert');
    alertBox.innerHTML = `ALERTA: Impacto de ${neo.name}\nLat: ${impactCoords.lat.toFixed(2)}, Lon: ${impactCoords.lon.toFixed(2)}`;
    alertBox.style.display = 'block';

    const direction = new THREE.Vector3().subVectors(camera.position, earth.position).normalize();
    const distance = EARTH_RADIUS_UNITS * 3;
    const newCamPos = new THREE.Vector3().addVectors(earth.position, direction.multiplyScalar(distance));
    
    let t = 0;
    const startPos = camera.position.clone();
    const startTarget = controls.target.clone();
    
    function zoom() {
        if (t < 1) {
            t += 0.02;
            camera.position.lerpVectors(startPos, newCamPos, t);
            controls.target.lerpVectors(startTarget, earth.position, t);
            requestAnimationFrame(zoom);
        }
    }
    zoom();

    setTimeout(() => {
        alertBox.style.display = 'none';
    }, 5000);
}

function createImpactMarker(impactPosition) {
    if (impactMarker) {
        earth.remove(impactMarker);
    }
    const markerGeometry = new THREE.CircleGeometry(EARTH_RADIUS_UNITS * 0.05, 32);
    const markerMaterial = new THREE.MeshBasicMaterial({ color: 0xff0000, side: THREE.DoubleSide });
    impactMarker = new THREE.Mesh(markerGeometry, markerMaterial);
    
    impactMarker.position.copy(impactPosition.multiplyScalar(1.01));
    impactMarker.lookAt(earth.position);
    earth.add(impactMarker);
}

// =============================================================================
// BUCLE DE ANIMACI√ìN
// =============================================================================
let lastTime = 0;
function animate(time) {
  requestAnimationFrame(animate);
  const deltaTime = (time - lastTime) * 0.001;
  lastTime = time;

  let elapsedMilliseconds = 0;
  if (!simState.isPaused && deltaTime > 0) {
    elapsedMilliseconds = deltaTime * BASE_SIMULATION_SPEED_DAYS_PER_SEC * simState.timeScale * 86400000;
    simState.date.setTime(simState.date.getTime() + elapsedMilliseconds);
    datePicker.value = simState.date.toISOString().split('T')[0];
  }
  
  const earthPos = getPositionFromOrbitalElements(earthOrbitalElements, simState.date);
  if (earthPos) earth.position.copy(earthPos);
  
  if (!simState.isPaused && elapsedMilliseconds > 0) {
    const dailyRotation = (elapsedMilliseconds / 86400000) * 2 * Math.PI;
    earth.rotation.y += dailyRotation;
  }

  neos.forEach(neo => {
    if (neo.impactDate && simState.date >= neo.impactDate) {
        if (neo.mesh.visible) {
            neo.mesh.visible = false;
            neo.orbitLine.visible = false;
            neo.label.visible = false;
        }
        return;
    } else if (neo.impactDate && simState.date < neo.impactDate) {
        neo.hasImpacted = false;
        neo.impactDate = null;
        const impactData = JSON.parse(localStorage.getItem(IMPACT_DATA_KEY)) || {};
        delete impactData[neo.id];
        localStorage.setItem(IMPACT_DATA_KEY, JSON.stringify(impactData));
    }
    
    if (!neo.mesh.visible) {
        neo.mesh.visible = true;
        neo.orbitLine.visible = true;
        neo.label.visible = true;
    }

    const pos = getPositionFromOrbitalElements(neo.orbital_data, simState.date);
    if (pos) {
        neo.mesh.position.copy(pos);
        
        if (!neo.hasImpacted) {
            const distanceToEarth = pos.distanceTo(earth.position);
            if (distanceToEarth < EARTH_RADIUS_UNITS + neo.mesh.geometry.parameters.radius) {
                neo.hasImpacted = true;
                neo.impactDate = new Date(simState.date);
                
                const impactData = JSON.parse(localStorage.getItem(IMPACT_DATA_KEY)) || {};
                impactData[neo.id] = neo.impactDate.toISOString();
                localStorage.setItem(IMPACT_DATA_KEY, JSON.stringify(impactData));

                simState.isPaused = true;
                updatePauseButtons(true);

                const lat = (Math.random() * 180 - 90);
                const lon = (Math.random() * 360 - 180);
                const impactPointLocal = neo.mesh.position.clone().sub(earth.position).normalize().multiplyScalar(EARTH_RADIUS_UNITS);
                
                showImpactAlert(neo, { lat, lon });
                createImpactMarker(impactPointLocal);
                
                if (selectedNeo && selectedNeo.id === neo.id) {
                    selectNeo(neo);
                }
            }
        }
    }
  });
  
  controls.update();
  renderer.render(scene, camera);
  labelRenderer.render(scene, camera);
}

// Iniciar la aplicaci√≥n
updatePauseButtons(simState.isPaused);
createStarfield();
loadCuratedNeos();
animate(0);

</script>
</body>
</html>